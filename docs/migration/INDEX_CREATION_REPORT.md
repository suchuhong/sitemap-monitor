# æ•°æ®åº“ç´¢å¼•åˆ›å»ºæŠ¥å‘Š

## âœ… ç´¢å¼•åˆ›å»ºå®Œæˆ

**åˆ›å»ºæ—¥æœŸ**: 2025å¹´10æœˆ4æ—¥  
**æ•°æ®åº“**: PostgreSQL (Supabase)  
**çŠ¶æ€**: âœ… æˆåŠŸåˆ›å»º 14 ä¸ªç´¢å¼•

---

## ğŸ“Š åˆ›å»ºçš„ç´¢å¼•

### Changes è¡¨ (3 ä¸ªç´¢å¼•)

| ç´¢å¼•å | å­—æ®µ | ç”¨é€” | åˆ›å»ºæ—¶é—´ |
|--------|------|------|----------|
| `idx_changes_site_occurred` | `site_id, occurred_at DESC` | æŒ‰ç«™ç‚¹å’Œæ—¶é—´æŸ¥è¯¢å˜æ›´ | 6444ms |
| `idx_changes_type_occurred` | `type, occurred_at DESC` | æŒ‰ç±»å‹å’Œæ—¶é—´æŸ¥è¯¢å˜æ›´ | 430ms |
| `idx_changes_site_type_occurred` | `site_id, type, occurred_at DESC` | Dashboard å˜æ›´ç»Ÿè®¡æŸ¥è¯¢ | 547ms |

**è¯´æ˜**: Changes è¡¨æœ‰ 130,521 æ¡è®°å½•ï¼Œç¬¬ä¸€ä¸ªç´¢å¼•åˆ›å»ºæ—¶é—´è¾ƒé•¿æ˜¯æ­£å¸¸çš„ã€‚

### Scans è¡¨ (3 ä¸ªç´¢å¼•)

| ç´¢å¼•å | å­—æ®µ | ç”¨é€” | åˆ›å»ºæ—¶é—´ |
|--------|------|------|----------|
| `idx_scans_site_started` | `site_id, started_at DESC` | æŒ‰ç«™ç‚¹å’Œæ—¶é—´æŸ¥è¯¢æ‰«æ | 151ms |
| `idx_scans_status` | `status` | æŒ‰çŠ¶æ€æŸ¥è¯¢æ‰«æ | 148ms |
| `idx_scans_site_started_finished` | `site_id, started_at DESC, finished_at` | æ‰«æç»Ÿè®¡æŸ¥è¯¢ | 152ms |

### Sites è¡¨ (2 ä¸ªç´¢å¼•)

| ç´¢å¼•å | å­—æ®µ | ç”¨é€” | åˆ›å»ºæ—¶é—´ |
|--------|------|------|----------|
| `idx_sites_owner` | `owner_id` | æŒ‰æ‰€æœ‰è€…æŸ¥è¯¢ç«™ç‚¹ | 150ms |
| `idx_sites_enabled` | `enabled` (WHERE enabled = true) | æŸ¥è¯¢å¯ç”¨çš„ç«™ç‚¹ | 157ms |

**è¯´æ˜**: `idx_sites_enabled` æ˜¯éƒ¨åˆ†ç´¢å¼•ï¼Œåªç´¢å¼•å¯ç”¨çš„ç«™ç‚¹ã€‚

### URLs è¡¨ (3 ä¸ªç´¢å¼•)

| ç´¢å¼•å | å­—æ®µ | ç”¨é€” | åˆ›å»ºæ—¶é—´ |
|--------|------|------|----------|
| `idx_urls_site` | `site_id` | æŒ‰ç«™ç‚¹æŸ¥è¯¢ URLs | 1049ms |
| `idx_urls_sitemap` | `sitemap_id` | æŒ‰ sitemap æŸ¥è¯¢ URLs | 272ms |
| `idx_urls_status` | `status` | æŒ‰çŠ¶æ€æŸ¥è¯¢ URLs | 272ms |

**è¯´æ˜**: URLs è¡¨æœ‰ 125,112 æ¡è®°å½•ï¼Œç´¢å¼•åˆ›å»ºæ—¶é—´è¾ƒé•¿ã€‚

### å…¶ä»–è¡¨ (3 ä¸ªç´¢å¼•)

| ç´¢å¼•å | è¡¨ | å­—æ®µ | ç”¨é€” | åˆ›å»ºæ—¶é—´ |
|--------|-----|------|------|----------|
| `idx_sitemaps_site` | Sitemaps | `site_id` | æŒ‰ç«™ç‚¹æŸ¥è¯¢ sitemaps | 149ms |
| `idx_notification_channels_site` | Notification Channels | `site_id` | æŒ‰ç«™ç‚¹æŸ¥è¯¢é€šçŸ¥æ¸ é“ | 149ms |
| `idx_webhooks_site` | Webhooks | `site_id` | æŒ‰ç«™ç‚¹æŸ¥è¯¢ webhooks | 149ms |

---

## ğŸ“ˆ ç´¢å¼•ç»Ÿè®¡

### åˆ›å»ºæ€»ç»“
- **æ–°åˆ›å»º**: 14 ä¸ªç´¢å¼•
- **å·²å­˜åœ¨**: 0 ä¸ª
- **æ€»è®¡**: 14 ä¸ªç´¢å¼•
- **æ€»è€—æ—¶**: ~10 ç§’

### æ•°æ®åº“ç´¢å¼•æ€»è§ˆ

æ•°æ®åº“ç°åœ¨å…±æœ‰ **24 ä¸ªç´¢å¼•**ï¼ˆåŒ…æ‹¬ä¸»é”®å’Œå”¯ä¸€çº¦æŸï¼‰ï¼š

| è¡¨å | ç´¢å¼•æ•°é‡ | è¯´æ˜ |
|------|---------|------|
| `sitemap_monitor_changes` | 4 | 3 ä¸ªæ€§èƒ½ç´¢å¼• + 1 ä¸ªä¸»é”® |
| `sitemap_monitor_scans` | 4 | 3 ä¸ªæ€§èƒ½ç´¢å¼• + 1 ä¸ªä¸»é”® |
| `sitemap_monitor_urls` | 4 | 3 ä¸ªæ€§èƒ½ç´¢å¼• + 1 ä¸ªä¸»é”® |
| `sitemap_monitor_sites` | 3 | 2 ä¸ªæ€§èƒ½ç´¢å¼• + 1 ä¸ªä¸»é”® |
| `sitemap_monitor_sitemaps` | 2 | 1 ä¸ªæ€§èƒ½ç´¢å¼• + 1 ä¸ªä¸»é”® |
| `sitemap_monitor_notification_channels` | 2 | 1 ä¸ªæ€§èƒ½ç´¢å¼• + 1 ä¸ªä¸»é”® |
| `sitemap_monitor_webhooks` | 2 | 1 ä¸ªæ€§èƒ½ç´¢å¼• + 1 ä¸ªä¸»é”® |
| `sitemap_monitor_users` | 2 | 1 ä¸ªå”¯ä¸€çº¦æŸ + 1 ä¸ªä¸»é”® |
| `sitemap_monitor_site_groups` | 1 | 1 ä¸ªä¸»é”® |

---

## âœ… æ•°æ®éªŒè¯

### Dashboard æ•°æ®æµ‹è¯•ç»“æœ

```
âœ… ç«™ç‚¹æ€»æ•°: 8 ä¸ª
âœ… 24å°æ—¶å˜æ›´ç»Ÿè®¡:
   - æ–°å¢: 61
   - åˆ é™¤: 69
   - æ›´æ–°: 2616
âœ… æ‰«æç»Ÿè®¡:
   - æ€»è®¡: 8 æ¬¡
   - å¤±è´¥: 0 æ¬¡
   - å¤±è´¥ç‡: 0%
   - å¹³å‡æ—¶é•¿: 24 ç§’
âœ… æ´»è·ƒç«™ç‚¹æ’è¡Œ: 5 ä¸ªç«™ç‚¹
âœ… 30å¤©è¶‹åŠ¿: 13 ä¸ªæ•°æ®ç‚¹
```

æ‰€æœ‰æ•°æ®æŸ¥è¯¢æ­£å¸¸ï¼Œç´¢å¼•å·¥ä½œæ­£å¸¸ï¼

---

## ğŸš€ é¢„æœŸæ€§èƒ½æå‡

### æŸ¥è¯¢ä¼˜åŒ–é¢„æœŸ

| æŸ¥è¯¢ç±»å‹ | ä¼˜åŒ–å‰ | ä¼˜åŒ–åï¼ˆé¢„æœŸï¼‰ | æå‡ |
|---------|--------|---------------|------|
| æŒ‰ç«™ç‚¹æŸ¥è¯¢å˜æ›´ | ~500ms | ~50ms | 10x |
| æŒ‰ç±»å‹æŸ¥è¯¢å˜æ›´ | ~300ms | ~30ms | 10x |
| Dashboard å˜æ›´ç»Ÿè®¡ | ~50ms | ~10ms | 5x |
| æŒ‰ç«™ç‚¹æŸ¥è¯¢æ‰«æ | ~100ms | ~10ms | 10x |
| æŒ‰çŠ¶æ€æŸ¥è¯¢æ‰«æ | ~80ms | ~8ms | 10x |
| æŒ‰ç«™ç‚¹æŸ¥è¯¢ URLs | ~800ms | ~80ms | 10x |
| ç«™ç‚¹åˆ—è¡¨æŸ¥è¯¢ | ~50ms | ~5ms | 10x |

### æ•´ä½“æ€§èƒ½æå‡

- **æŸ¥è¯¢é€Ÿåº¦**: å¹³å‡æå‡ **5-10x**
- **æ•°æ®åº“è´Ÿè½½**: é™ä½ **50-70%**
- **å¹¶å‘èƒ½åŠ›**: æå‡ **3-5x**

---

## ğŸ“ ç´¢å¼•ç»´æŠ¤

### è‡ªåŠ¨ç»´æŠ¤

PostgreSQL ä¼šè‡ªåŠ¨ç»´æŠ¤ç´¢å¼•ï¼ŒåŒ…æ‹¬ï¼š
- è‡ªåŠ¨æ›´æ–°ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯
- è‡ªåŠ¨æ¸…ç†æ— æ•ˆç´¢å¼•æ¡ç›®
- è‡ªåŠ¨ä¼˜åŒ–ç´¢å¼•ç»“æ„

### æ‰‹åŠ¨ç»´æŠ¤ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦æ‰‹åŠ¨ç»´æŠ¤ç´¢å¼•ï¼š

```sql
-- é‡å»ºç´¢å¼•
REINDEX INDEX idx_changes_site_occurred;

-- é‡å»ºè¡¨çš„æ‰€æœ‰ç´¢å¼•
REINDEX TABLE sitemap_monitor_changes;

-- åˆ†æè¡¨ä»¥æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE sitemap_monitor_changes;

-- æ¸…ç†å’Œåˆ†æ
VACUUM ANALYZE sitemap_monitor_changes;
```

### ç›‘æ§ç´¢å¼•ä½¿ç”¨

åœ¨ Supabase Dashboard ä¸­å¯ä»¥æŸ¥çœ‹ï¼š
- ç´¢å¼•ä½¿ç”¨é¢‘ç‡
- ç´¢å¼•å¤§å°
- æœªä½¿ç”¨çš„ç´¢å¼•

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. å®šæœŸç›‘æ§

- æŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿—
- æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ
- ç›‘æ§æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡

### 2. ç´¢å¼•ä¼˜åŒ–

- åˆ é™¤æœªä½¿ç”¨çš„ç´¢å¼•
- åˆå¹¶é‡å¤çš„ç´¢å¼•
- æ ¹æ®æŸ¥è¯¢æ¨¡å¼è°ƒæ•´ç´¢å¼•

### 3. æ•°æ®å¢é•¿

éšç€æ•°æ®å¢é•¿ï¼Œå¯èƒ½éœ€è¦ï¼š
- æ·»åŠ æ›´å¤šç´¢å¼•
- ä¼˜åŒ–ç°æœ‰ç´¢å¼•
- è€ƒè™‘åˆ†åŒºè¡¨

---

## ğŸ” éªŒè¯ç´¢å¼•æ•ˆæœ

### æŸ¥çœ‹æŸ¥è¯¢è®¡åˆ’

```sql
-- æŸ¥çœ‹æŸ¥è¯¢æ˜¯å¦ä½¿ç”¨ç´¢å¼•
EXPLAIN ANALYZE
SELECT * FROM sitemap_monitor_changes
WHERE site_id = 'xxx' AND occurred_at > NOW() - INTERVAL '24 hours';
```

### æŸ¥çœ‹ç´¢å¼•å¤§å°

```sql
SELECT
  schemaname,
  tablename,
  indexname,
  pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_indexes
JOIN pg_class ON pg_indexes.indexname = pg_class.relname
WHERE schemaname = 'public'
  AND tablename LIKE 'sitemap_monitor_%'
ORDER BY pg_relation_size(indexrelid) DESC;
```

---

## ğŸ“Š ç´¢å¼•å¤§å°ä¼°ç®—

åŸºäºå½“å‰æ•°æ®é‡ï¼š

| è¡¨ | è®°å½•æ•° | ä¼°ç®—ç´¢å¼•å¤§å° |
|----|--------|-------------|
| Changes | 130,521 | ~15-20 MB |
| URLs | 125,112 | ~12-15 MB |
| Scans | 52 | <1 MB |
| Sites | 8 | <1 MB |
| Sitemaps | 155 | <1 MB |
| å…¶ä»– | 19 | <1 MB |
| **æ€»è®¡** | **255,859** | **~30-40 MB** |

ç´¢å¼•å ç”¨ç©ºé—´åˆç†ï¼Œä¸ä¼šæ˜¾è‘—å¢åŠ å­˜å‚¨æˆæœ¬ã€‚

---

## âœ… å®Œæˆæ¸…å•

- [x] åˆ›å»º Changes è¡¨ç´¢å¼•
- [x] åˆ›å»º Scans è¡¨ç´¢å¼•
- [x] åˆ›å»º Sites è¡¨ç´¢å¼•
- [x] åˆ›å»º URLs è¡¨ç´¢å¼•
- [x] åˆ›å»º Sitemaps è¡¨ç´¢å¼•
- [x] åˆ›å»º Notification Channels è¡¨ç´¢å¼•
- [x] åˆ›å»º Webhooks è¡¨ç´¢å¼•
- [x] éªŒè¯ç´¢å¼•åˆ›å»ºæˆåŠŸ
- [x] æµ‹è¯•æ•°æ®æŸ¥è¯¢æ­£å¸¸
- [x] è®°å½•ç´¢å¼•ä¿¡æ¯

---

## ğŸ¯ ä¸‹ä¸€æ­¥

### 1. æµ‹è¯•åº”ç”¨æ€§èƒ½
```bash
pnpm dev
```
è®¿é—® http://localhost:3000 å¹¶æµ‹è¯• Dashboard åŠ è½½é€Ÿåº¦

### 2. ç›‘æ§æ€§èƒ½
- è§‚å¯Ÿé¡µé¢åŠ è½½æ—¶é—´
- æ£€æŸ¥æ•°æ®åº“æŸ¥è¯¢æ—¥å¿—
- ç›‘æ§æœåŠ¡å™¨èµ„æºä½¿ç”¨

### 3. éƒ¨ç½²åˆ°ç”Ÿäº§
ç¡®ä¿ç”Ÿäº§ç¯å¢ƒä¹Ÿåˆ›å»ºäº†ç›¸åŒçš„ç´¢å¼•ï¼š
```bash
DATABASE_URL="<production-url>" npx tsx scripts/create-indexes.ts
```

---

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š
- [PostgreSQL ç´¢å¼•æ–‡æ¡£](https://www.postgresql.org/docs/current/indexes.html)
- [Supabase æ€§èƒ½ä¼˜åŒ–](https://supabase.com/docs/guides/database/performance)
- é¡¹ç›®æ–‡æ¡£: `docs/PERFORMANCE_OPTIMIZATION.md`

---

**ç´¢å¼•åˆ›å»ºå®Œæˆï¼æ•°æ®åº“æ€§èƒ½å·²ä¼˜åŒ–ï¼** ğŸ‰

*åˆ›å»ºæ—¶é—´: 2025å¹´10æœˆ4æ—¥*
