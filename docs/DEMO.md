# 功能演示

## 页面通知功能演示

### 操作步骤

1. **访问站点详情页面**
   ```
   http://localhost:3000/sites/{siteId}
   ```

2. **点击"手动扫描"按钮**
   - 页面会显示 "扫描已启动" 的提示
   - 按钮变为 "处理中..." 状态

3. **等待扫描完成**
   - 系统每 5 秒自动检查扫描状态
   - 无需刷新页面

4. **查看通知**
   - 扫描完成后自动弹出通知
   - 显示详细的扫描结果

### 通知示例

#### 成功通知（有变更）
```
✅ 扫描完成
新增 5 / 删除 2 / 更新 3 · 耗时 12.5s
```

#### 成功通知（无变更）
```
✅ 扫描完成
无变更 · 耗时 8.2s
```

#### 失败通知
```
❌ 扫描失败
Network timeout
```

#### 重复扫描提示
```
✅ 该站点已有扫描任务在执行中
```

## 完整流程演示

### 1. 触发扫描

```bash
# 方式 1：通过页面按钮
点击站点详情页面的 "手动扫描" 按钮

# 方式 2：通过 API
curl -X POST "http://localhost:3000/api/sites/{siteId}/scan" \
  -H "Cookie: session=your-session"
```

### 2. 监控状态

页面会自动监控扫描状态，无需手动操作。

**监控流程**：
```
触发扫描
  ↓
显示 "扫描已启动" 提示
  ↓
后台每 5 秒检查状态
  ↓
扫描完成
  ↓
弹出通知
  ↓
自动刷新页面
```

### 3. 查看结果

扫描完成后，页面会自动刷新并显示：
- 最新的 URL 统计
- 扫描历史记录
- 变更详情

## 测试场景

### 场景 1：正常扫描

1. 访问站点详情页面
2. 点击 "手动扫描"
3. 等待 10-30 秒
4. 查看成功通知
5. 确认页面已刷新

### 场景 2：扫描失败

1. 修改站点 URL 为无效地址
2. 触发扫描
3. 等待失败通知
4. 查看错误信息

### 场景 3：重复扫描

1. 触发第一次扫描
2. 立即再次点击 "手动扫描"
3. 查看 "已有扫描任务在执行中" 提示

### 场景 4：页面刷新后继续监控

1. 触发扫描
2. 刷新页面
3. 系统自动检测到运行中的扫描
4. 继续监控直到完成

## 浏览器兼容性

### 支持的浏览器

- ✅ Chrome 90+
- ✅ Firefox 88+
- ✅ Safari 14+
- ✅ Edge 90+

### 功能支持

| 功能 | Chrome | Firefox | Safari | Edge |
|------|--------|---------|--------|------|
| Toast 通知 | ✅ | ✅ | ✅ | ✅ |
| 自定义事件 | ✅ | ✅ | ✅ | ✅ |
| 轮询 | ✅ | ✅ | ✅ | ✅ |
| 自动刷新 | ✅ | ✅ | ✅ | ✅ |

## 性能指标

### 响应时间

- 触发扫描：< 500ms
- 状态检查：< 200ms
- 通知显示：< 100ms

### 资源占用

- 轮询请求：每 5 秒 1 次
- 请求大小：< 10KB
- 内存占用：< 1MB

### 网络流量

假设扫描耗时 30 秒：
- 轮询次数：6 次
- 总流量：< 60KB

## 调试技巧

### 查看监控状态

打开浏览器控制台，输入：

```javascript
// 查看当前监控的扫描
console.log(window.__scanMonitor);
```

### 手动触发检查

```javascript
// 手动触发一次状态检查
window.dispatchEvent(new Event('check-scans'));
```

### 查看轮询日志

在 `scan-monitor.tsx` 中添加日志：

```typescript
const checkScans = async () => {
  console.log('Checking scans...', monitoredScansRef.current);
  // ...
};
```

## 常见问题

### Q: 通知不显示？

A: 检查以下几点：
1. Toaster 是否在 layout.tsx 中配置
2. 浏览器控制台是否有错误
3. sonner 包是否已安装

### Q: 轮询不工作？

A: 检查：
1. API 端点是否正常响应
2. 扫描 ID 是否正确
3. 浏览器网络面板中的请求

### Q: 页面不刷新？

A: 确认：
1. 没有 JavaScript 错误
2. window.location.reload() 没有被注释
3. 浏览器允许页面刷新

## 下一步

- [ ] 添加声音提示
- [ ] 支持桌面通知
- [ ] 添加扫描进度条
- [ ] 使用 WebSocket 实时推送
- [ ] 支持多站点同时监控

## 相关文档

- [前端页面通知](./FRONTEND_NOTIFICATIONS.md)
- [扫描完成通知](./SCAN_NOTIFICATIONS.md)
- [队列系统优化](./QUEUE_OPTIMIZATION.md)
