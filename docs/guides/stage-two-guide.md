# 阶段 2：监控能力增强使用指南

阶段 2 聚焦于“监控能力增强”，本文介绍新增功能的背景、入口与核心操作流程，帮助你快速体验这些能力。

## 1. 差异报告（Scan Diff）

- **入口**：`/sites/:id` 站点详情页新增“差异报告”面板。
- **用法**：
  1. 在页面中选择需要查看的扫描记录（默认选择最近一次）。
  2. 面板会从 `/api/sites/:id/scan-diff?scanId=xxx` 获取细粒度差异，包括新增、删除、更新的 URL 列表。
  3. 若为 Stage 2 之前的老扫描记录，可能因为缺少 `scanId` 标记而显示为空。
- **提示**：列表支持直接刷新，若需要比较最新变化，可先触发一次手动扫描再查看报告。

## 2. 多渠道告警

- **入口**：`/sites/:id` → “通知渠道” 面板。
- **新增渠道**：
  - Webhook：填写回调地址，可选 HMAC 密钥（与日志中的签名保持一致）。
  - Email：输入收件地址，系统将通过配置好的 SMTP 服务发送正式邮件。
  - Slack：填写 Slack Incoming Webhook URL（或自建 API 地址 + Bearer Token），系统会直接推送消息到频道。
- **API**：
  - `GET /api/sites/:id/notifications` 获取当前渠道列表。
  - `POST /api/sites/:id/notifications` 添加渠道。
  - `DELETE /api/sites/:id/notifications/:notificationId` 移除渠道。
- **触发**：当扫描任务无错误且存在新增/删除/更新 URL 时，`notifyChange` 会遍历所有渠道完成投递。
- **配置要求**：邮件与 Slack 渠道需要提前在 `.env` 中配置 SMTP / 超时等参数，详见《通知渠道配置与调试指南》。

## 3. 扫描调度（外部触发）

- **配置项**：
  - **扫描优先级**：范围 1~5，数字越大表示越优先；可在站点设置中调整。
  - **扫描间隔（分钟）**：最小 5 分钟，默认 1440（即每日一次）。
- **外部 Cron**：
  - 通过外部定时任务服务命中 `POST /api/cron/scan`，系统会根据优先级与 `lastScanAt` 判断是否到期。
  - 未到达扫描间隔的站点会被跳过，降低资源消耗。
  - 符合条件的站点会调用 `enqueueScan` 加入系统内的扫描队列，避免阻塞 Web 请求。
- **UI 展示**：站点列表新增“扫描策略”列，可快速查看优先级、间隔与最近一次扫描时间。

## 4. 其他体验更新

- 扫描趋势图、最近扫描列表中新增 “更新” 统计，帮助识别内容调整。
- 站点详情顶部信息展示最近一次扫描时间，方便确认外部调度是否生效。
- 批量导入面板延续 Stage 1 的反馈体验，可与差异报告配合快速验证导入效果。

---

如需进一步规划下一阶段，可继续参阅 `docs/roadmap.md`；若在使用中发现问题，欢迎编辑本文档或提交 Issue 反馈。
