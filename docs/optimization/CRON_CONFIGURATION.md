# Cron 配置说明

## 当前配置

### Vercel Cron Jobs

```json
{
  "crons": [
    {
      "path": "/api/cron/scan?max=1",
      "schedule": "*/10 * * * *"
    }
  ]
}
```

**说明**:
- **频率**: 每 10 分钟执行一次
- **每次扫描**: 1 个站点
- **完整扫描周期**: 约 80 分钟（8 个站点）

---

## 执行统计

### 每日执行次数

```
每小时: 6 次
每天: 6 × 24 = 144 次
每月: 144 × 30 = 4,320 次
```

### 资源消耗

- **函数调用**: 4,320 次/月
- **免费限额**: 1,000,000 次/月
- **使用率**: 0.43% ✅
- **完全在免费限额内**

---

## 扫描逻辑

### 优先级排序

站点按以下顺序扫描：

1. **扫描优先级** (scanPriority) - 数值越大越优先
2. **最后扫描时间** - 越久未扫描越优先

### 扫描条件

只有满足以下条件的站点才会被扫描：

1. **启用状态**: `enabled = true`
2. **到期时间**: 距离上次扫描已超过 `scanIntervalMinutes`

### 默认扫描间隔

- **默认值**: 1440 分钟（24 小时）
- **最小值**: 5 分钟
- **可在站点设置中自定义**

---

## 配置调整建议

### 场景 1: 站点数量少（< 5 个）

可以降低频率：

```json
{
  "crons": [{
    "path": "/api/cron/scan?max=1",
    "schedule": "*/15 * * * *"
  }]
}
```

### 场景 2: 站点数量多（> 10 个）

可以提高频率：

```json
{
  "crons": [{
    "path": "/api/cron/scan?max=1",
    "schedule": "*/5 * * * *"
  }]
}
```

### 场景 3: 需要更快扫描

增加每次扫描数量（需要测试不超时）：

```json
{
  "crons": [{
    "path": "/api/cron/scan?max=2",
    "schedule": "*/10 * * * *"
  }]
}
```

### 场景 4: 分时段配置

工作时间更频繁：

```json
{
  "crons": [
    {
      "path": "/api/cron/scan?max=1",
      "schedule": "*/5 8-20 * * *"
    },
    {
      "path": "/api/cron/scan?max=1",
      "schedule": "*/30 21-7 * * *"
    }
  ]
}
```

---

## Cron 表达式说明

### 格式

```
* * * * *
│ │ │ │ │
│ │ │ │ └─ 星期几 (0-7, 0 和 7 都表示周日)
│ │ │ └─── 月份 (1-12)
│ │ └───── 日期 (1-31)
│ └─────── 小时 (0-23)
└───────── 分钟 (0-59)
```

### 常用示例

| 表达式 | 说明 |
|--------|------|
| `*/5 * * * *` | 每 5 分钟 |
| `*/10 * * * *` | 每 10 分钟 |
| `*/15 * * * *` | 每 15 分钟 |
| `0 * * * *` | 每小时整点 |
| `0 */2 * * *` | 每 2 小时 |
| `0 9 * * *` | 每天 9:00 |
| `0 9,17 * * *` | 每天 9:00 和 17:00 |
| `0 9 * * 1-5` | 工作日 9:00 |
| `*/10 8-20 * * *` | 8:00-20:00 每 10 分钟 |

---

## 监控和调试

### 查看执行日志

1. **Vercel Dashboard**
   - 进入项目
   - Settings → Cron Jobs
   - 查看执行历史

2. **函数日志**
   - Deployments → 选择部署
   - Functions → 查看日志

### 手动触发测试

```bash
# 使用 curl 测试
curl -X POST "https://your-app.vercel.app/api/cron/scan?max=1" \
  -H "Authorization: Bearer YOUR_CRON_TOKEN"

# 或使用 x-cron-token header
curl -X POST "https://your-app.vercel.app/api/cron/scan?max=1" \
  -H "x-cron-token: YOUR_CRON_TOKEN"
```

### 查看扫描结果

API 返回格式：

```json
{
  "sitesChecked": 8,
  "dueCount": 3,
  "queued": 1,
  "results": [
    {
      "siteId": "xxx",
      "scanId": "yyy",
      "status": "queued"
    }
  ]
}
```

**字段说明**:
- `sitesChecked`: 检查的启用站点总数
- `dueCount`: 需要扫描的站点数量
- `queued`: 本次实际入队的站点数量
- `results`: 扫描结果详情

---

## 常见问题

### Q: 为什么每次只扫描 1 个站点？

A: 避免 Vercel Serverless Function 超时（10 秒限制）。每个站点的扫描可能需要几秒钟，扫描多个站点容易超时。

### Q: 8 个站点需要多久扫描完一轮？

A: 
- 每 10 分钟扫描 1 个
- 8 个站点 = 80 分钟
- 约 1 小时 20 分钟完成一轮

### Q: 可以更频繁吗？

A: 可以，但要注意：
- 每 5 分钟: 40 分钟一轮（推荐）
- 每 3 分钟: 24 分钟一轮（可能过于频繁）
- 每分钟: 8 分钟一轮（不推荐，浪费资源）

### Q: 如何确保重要站点优先扫描？

A: 在站点设置中提高 `scanPriority` 值：
- 高优先级: 10
- 普通优先级: 1（默认）
- 低优先级: 0

### Q: 如何调整单个站点的扫描频率？

A: 修改站点的 `scanIntervalMinutes` 值：
- 频繁扫描: 60 分钟
- 正常扫描: 1440 分钟（24 小时，默认）
- 低频扫描: 2880 分钟（48 小时）

### Q: Cron 没有执行怎么办？

A: 检查以下几点：
1. `vercel.json` 是否已提交并部署
2. `CRON_TOKEN` 环境变量是否设置
3. 在 Vercel Dashboard 查看 Cron Jobs 状态
4. 查看函数日志是否有错误

---

## 性能优化建议

### 1. 合理设置扫描间隔

不是所有站点都需要频繁扫描：

- **新闻站点**: 60-120 分钟
- **博客**: 1440 分钟（24 小时）
- **企业官网**: 2880 分钟（48 小时）

### 2. 使用优先级

重要站点设置高优先级，确保优先扫描。

### 3. 监控扫描时长

如果单个站点扫描时间过长（> 5 秒），考虑：
- 检查 sitemap 大小
- 优化网络请求
- 增加超时时间

### 4. 避免重复扫描

系统会自动跳过未到期的站点，无需担心重复扫描。

---

## 部署后验证

### 1. 检查 Cron 配置

```bash
# 查看 vercel.json
cat vercel.json
```

### 2. 部署到 Vercel

```bash
git add vercel.json
git commit -m "chore: update cron configuration"
git push origin main
```

### 3. 验证 Cron Jobs

在 Vercel Dashboard:
1. 进入项目
2. Settings → Cron Jobs
3. 确认看到配置的 Cron 任务

### 4. 手动触发测试

等待下一个执行时间，或使用 curl 手动触发。

### 5. 查看执行结果

在 Cron Jobs 页面查看执行历史和状态。

---

## 更新历史

- **2025-10-04**: 初始配置，每 10 分钟扫描 1 个站点
- **配置**: `*/10 * * * *`, `max=1`

---

*文档更新时间: 2025年10月4日*
